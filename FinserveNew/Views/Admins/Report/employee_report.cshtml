@{
    ViewData["Title"] = "Employee Dashboard Report";
    var submitter = ViewBag.SubmitterName ?? "Employee";
    var submittedAt = DateTime.Now.ToString("dd MMM yyyy HH:mm");

    // Claims
    int totalClaims = (int?)ViewBag.TotalClaims ?? 0;
    int approvedClaims = (int?)ViewBag.ApprovedClaims ?? 0;
    int pendingClaims = (int?)ViewBag.PendingClaims ?? 0;
    double approvalRate = (double?)ViewBag.ApprovalRate ?? 0.0;
    decimal totalClaimAmount = (decimal?)ViewBag.TotalClaimAmount ?? 0m;
    var recentClaims = ViewBag.RecentClaims as IEnumerable<FinserveNew.Models.Claim> ?? new List<FinserveNew.Models.Claim>();

    // Leaves
    double totalDaysUsed = (double?)ViewBag.TotalLeaveDaysUsed ?? 0.0;
    double totalRemaining = (double?)ViewBag.TotalRemainingLeave ?? 0.0;
    double totalDefault = (double?)ViewBag.TotalDefaultDays ?? 0.0;
    var leaveBalances = ViewBag.LeaveBalances as IDictionary<string, object> ?? new Dictionary<string, object>();
    var recentLeaves = ViewBag.RecentLeaves as IEnumerable<FinserveNew.Models.LeaveModel> ?? new List<FinserveNew.Models.LeaveModel>();
    var calendarData = ViewBag.CalendarData as IDictionary<string, List<int>> ?? new Dictionary<string, List<int>>();
}

<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Employee Dashboard Report</h3>
        <small class="text-muted">Submitted by: @submitter â€¢ @submittedAt</small>
    </div>

    <div class="card mb-3">
        <div class="card-header">Overview</div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3 mb-2">
                    <div class="fw-bold">Total Claims</div>
                    <div class="fs-4">@totalClaims</div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="fw-bold">Approved Claims</div>
                    <div class="fs-4 text-success">@approvedClaims</div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="fw-bold">Pending Claims</div>
                    <div class="fs-4 text-warning">@pendingClaims</div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="fw-bold">Approval Rate</div>
                    <div class="fs-4">@approvalRate%</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header">Claims Summary</div>
        <div class="card-body">
            <p class="mb-2">Total (Approved) Amount: <strong>@totalClaimAmount.ToString("N2")</strong></p>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Claim ID</th>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var c in recentClaims)
                        {
                            <tr>
                                <td>@c.DisplayClaimId</td>
                                <td>@c.CreatedDate.ToString("dd MMM yyyy")</td>
                                <td>@c.ClaimType</td>
                                <td>@c.DisplayAmount</td>
                                <td>@c.Status</td>
                            </tr>
                        }
                        @if (!recentClaims.Any())
                        {
                            <tr><td colspan="5" class="text-center text-muted">No recent claims</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header">Leave Summary</div>
        <div class="card-body">
            <div class="row text-center mb-3">
                <div class="col-md-4 mb-2">
                    <div class="fw-bold">Used Days</div>
                    <div class="fs-4">@totalDaysUsed</div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="fw-bold">Remaining Days</div>
                    <div class="fs-4 text-success">@totalRemaining</div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="fw-bold">Default Days</div>
                    <div class="fs-4">@totalDefault</div>
                </div>
            </div>

            <h6>Leave Balances</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Used</th>
                            <th>Remaining</th>
                            <th>Default</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (leaveBalances != null && leaveBalances.Any())
                        {
                            foreach (var entry in leaveBalances)
                            {
                                dynamic val = entry.Value;
                                <tr>
                                    <td>@entry.Key</td>
                                    <td>@(val?.UsedDays ?? 0)</td>
                                    <td>@(val?.RemainingDays ?? 0)</td>
                                    <td>@(val?.DefaultDays ?? 0)</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="4" class="text-center text-muted">No balance data</td></tr>
                        }
                    </tbody>
                </table>
            </div>

            <h6 class="mt-3">Recent Leaves</h6>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Leave ID</th>
                            <th>Type</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Days</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var l in recentLeaves)
                        {
                            var days = l.LeaveDays > 0 ? l.LeaveDays : l.CalculatedLeaveDays;
                            <tr>
                                <td>@l.DisplayLeaveId</td>
                                <td>@(l.LeaveType?.TypeName ?? "-")</td>
                                <td>@l.StartDate.ToString("dd MMM yyyy")</td>
                                <td>@l.EndDate.ToString("dd MMM yyyy")</td>
                                <td>@days</td>
                                <td>@l.Status</td>
                            </tr>
                        }
                        @if (!recentLeaves.Any())
                        {
                            <tr><td colspan="6" class="text-center text-muted">No recent leaves</td></tr>
                        }
                    </tbody>
                </table>
            </div>

            <h6 class="mt-3">Approved Leave Days (Calendar)</h6>
            <p class="text-muted">Total approved days this year: <strong>@(calendarData?.Values.Sum(v => v.Count) ?? 0)</strong></p>
        </div>
    </div>

    <div class="alert alert-info">
        This report was submitted from the Employee Dashboard to Admin for review.
    </div>
</div>


