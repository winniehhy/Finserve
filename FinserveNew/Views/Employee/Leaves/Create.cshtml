@model FinserveNew.Models.LeaveModel

@{
    ViewData["Title"] = "Apply for Leave";

    // Create leave types list if not provided by controller
    var leaveTypes = ViewData["LeaveTypeID"] as IEnumerable<SelectListItem> ?? new List<SelectListItem>
    {
        new SelectListItem { Value = "1", Text = "Annual Leave" },
        new SelectListItem { Value = "2", Text = "Medical Leave" },
        new SelectListItem { Value = "3", Text = "Hospitalization Leave" },
        new SelectListItem { Value = "4", Text = "Emergency Leave" }
    };
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="page-title mb-0">Apply for Leave</h2>
    <a href="/Leaves/LeaveRecords" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i>
        Back to My Leaves
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title">Leave Application Form</h4>
            </div>
            <div class="card-body">
                <form asp-action="Create" method="post" enctype="multipart/form-data">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="LeaveTypeID" class="form-label">Leave Type <span class="text-danger">*</span></label>
                            <select asp-for="LeaveTypeID" asp-items="leaveTypes" class="form-select" id="LeaveTypeID" required>
                                <option value="">-- Select Leave Type --</option>
                            </select>
                            <span asp-validation-for="LeaveTypeID" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Available Days</label>
                            <div id="availableDays" class="form-control bg-light text-muted">
                                Select a leave type to see available days
                            </div>
                        </div>
                    </div>

                    <!-- Half Day / Full Day Selection -->
                    <div class="mb-3" id="dayTypeSection" style="display: none;">
                        <label class="form-label">Day Type <span class="text-danger">*</span></label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="DayType" id="fullDay" value="full" checked>
                                <label class="form-check-label" for="fullDay">
                                     Full Day
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="DayType" id="halfDay" value="half">
                                <label class="form-check-label" for="halfDay">
                                     Half Day
                                </label>
                            </div>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Half day will deduct 0.5 days from your leave balance
                        </div>
                    </div>

                    <!-- Medical Certificate Upload Section (Hidden by default) -->
                    <div class="mb-3" id="medicalCertificateSection" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-file-medical me-2"></i>
                            <strong>Medical Certificate Required:</strong> Please upload an official medical certificate to support your medical leave application.
                        </div>

                        <label class="form-label">Medical Certificate <span class="text-danger">*</span></label>
                        <input type="file" name="MedicalCertificate" id="MedicalCertificate"
                               class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Accepted formats: PDF, JPG, PNG, DOC, DOCX (Max size: 5MB)
                        </div>
                        <span id="medicalCertificateError" class="text-danger" style="display: none;"></span>

                        <!-- File preview area -->
                        <div id="filePreview" class="mt-2" style="display: none;">
                            <div class="border rounded p-2 bg-light">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-alt me-2 text-primary"></i>
                                    <span id="fileName" class="me-auto"></span>
                                    <span id="fileSize" class="text-muted small me-2"></span>
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="removeFile">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="StartDate" class="form-label">Start Date <span class="text-danger">*</span></label>
                            <input asp-for="StartDate" type="date" class="form-control" id="StartDate" required />
                            <span asp-validation-for="StartDate" class="text-danger"></span>
                            <div class="form-text" id="dateHelp">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="dateHelpText">Select dates from today onwards</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="EndDate" class="form-label">End Date <span class="text-danger">*</span></label>
                            <input asp-for="EndDate" type="date" class="form-control" id="EndDate" required />
                            <span asp-validation-for="EndDate" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="alert alert-info" id="durationInfo" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Duration:</strong> <span id="calculatedDuration">0</span> day(s)
                            <div id="balanceWarning" style="display: none;" class="mt-2">
                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                <span class="text-warning">Warning: This exceeds your available balance!</span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Reason" class="form-label">Reason <span class="text-danger">*</span></label>
                        <textarea asp-for="Reason" class="form-control" id="Reason" rows="4"
                                  placeholder="Please provide a detailed reason for your leave application" required></textarea>
                        <span asp-validation-for="Reason" class="text-danger"></span>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <a asp-action="LeaveRecords" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-2"></i>Submit Application
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Leave Balance Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>Annual Leave:</strong>
                        <span class="badge bg-primary">@(ViewBag.AnnualLeaveBalance ?? 0) / 14</span>
                    </div>
                    <div class="progress mt-1" style="height: 8px;">
                        <div class="progress-bar bg-primary" role="progressbar"
                             style="width: @(((ViewBag.AnnualLeaveBalance != null ? (double)ViewBag.AnnualLeaveBalance : 0) / 14) * 100)%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>Medical Leave:</strong>
                        <span class="badge bg-info">@(ViewBag.MedicalLeaveBalance ?? 0) / 10</span>
                    </div>
                    <div class="progress mt-1" style="height: 8px;">
                        <div class="progress-bar bg-info" role="progressbar"
                             style="width: @(((ViewBag.MedicalLeaveBalance != null ? (double)ViewBag.MedicalLeaveBalance : 0) / 10) * 100)%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>Hospitalization Leave:</strong>
                        <span class="badge bg-success">@(ViewBag.HospitalizationLeaveBalance ?? 0) / 16</span>
                    </div>
                    <div class="progress mt-1" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: @(((ViewBag.HospitalizationLeaveBalance != null ? (double)ViewBag.HospitalizationLeaveBalance : 0) / 16) * 100)%"></div>
                    </div>
                </div>
                <div class="mb-0">
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <small><strong>Emergency Leave:</strong> Deducts from Annual Leave balance</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Tips
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <small>Plan your leave in advance</small>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <small>Medical leave requires documentation</small>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <small>Emergency leave deducts from annual balance</small>
                    </li>
                    <li class="mb-0">
                        <i class="fas fa-check text-success me-2"></i>
                        <small>Annual leave expires at year-end</small>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>

               $(document).ready(function() {
            console.log('Form script initialized');

            // ✅ SIMPLIFIED: Build leave balances object directly from ViewBag values
            const leaveBalances = {
                '1': {
                    typeName: 'Annual Leave',
                    maxDays: 14,
                    remaining: @(ViewBag.AnnualLeaveBalance ?? 14),
                    allowBackdate: true
                },
                '2': {
                    typeName: 'Medical Leave',
                    maxDays: 10,
                    remaining: @(ViewBag.MedicalLeaveBalance ?? 10),
                    allowBackdate: true
                },
                '3': {
                    typeName: 'Hospitalization Leave',
                    maxDays: 16,
                    remaining: @(ViewBag.HospitalizationLeaveBalance ?? 16),
                    allowBackdate: true
                },
                '4': {
                    typeName: 'Emergency Leave',
                    maxDays: 14,
                    remaining: @(ViewBag.AnnualLeaveBalance ?? 14), // ✅ Emergency uses Annual Leave balance
                    allowBackdate: true
                }
            };

            console.log("Leave Balances:", leaveBalances);

            // File validation settings
            const maxFileSize = 5 * 1024 * 1024; // 5MB
            const allowedExtensions = ['.pdf', '.jpg', '.jpeg', '.png', '.doc', '.docx'];

            // ✅ FIXED: Validate leave type selection
            function isValidLeaveType(leaveTypeId) {
                const isValid = Object.keys(leaveBalances).includes(leaveTypeId);
                console.log('Validating leave type:', leaveTypeId, 'Is valid:', isValid);
                return isValid;
            }

            // File validation function
            function validateFile(file) {
                if (!file) return { isValid: false, message: 'No file selected' };

                const fileName = file.name.toLowerCase();
                const fileExtension = fileName.substring(fileName.lastIndexOf('.'));

                if (!allowedExtensions.includes(fileExtension)) {
                    return {
                        isValid: false,
                        message: 'Invalid file type. Please select PDF, JPG, PNG, DOC, or DOCX files only.'
                    };
                }

                if (file.size > maxFileSize) {
                    return {
                        isValid: false,
                        message: 'File size exceeds 5MB limit. Please select a smaller file.'
                    };
                }

                return { isValid: true, message: '' };
            }

            // Format file size
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // ✅ FIXED: Update date restrictions based on leave type
            function updateDateRestrictions(leaveTypeId) {
                const today = new Date().toISOString().split('T')[0];
                const startDateInput = $('#StartDate');
                const endDateInput = $('#EndDate');
                const dateHelpText = $('#dateHelpText');

                if (isValidLeaveType(leaveTypeId) && leaveBalances[leaveTypeId].allowBackdate) {
                    // Allow backdate for medical, hospitalization, and emergency leave
                    startDateInput.removeAttr('min');
                    endDateInput.removeAttr('min');
                    dateHelpText.html('<i class="fas fa-calendar-alt me-1"></i>You can select past dates for this leave type');
                } else {
                    // Restrict to future dates for annual leave
                    startDateInput.attr('min', today);
                    endDateInput.attr('min', today);
                    dateHelpText.html('<i class="fas fa-calendar-plus me-1"></i>Select dates from today onwards');
                }

                // Update end date minimum when start date changes
                const startDate = startDateInput.val();
                if (startDate) {
                    endDateInput.attr('min', startDate);
                }
            }

            // Handle medical certificate file selection
            $('#MedicalCertificate').on('change', function() {
                const file = this.files[0];
                const errorSpan = $('#medicalCertificateError');
                const filePreview = $('#filePreview');

                if (file) {
                    const validation = validateFile(file);

                    if (!validation.isValid) {
                        errorSpan.text(validation.message).show();
                        filePreview.hide();
                        this.value = ''; // Clear the file input
                        return;
                    }

                    // Hide error and show preview
                    errorSpan.hide();
                    $('#fileName').text(file.name);
                    $('#fileSize').text(formatFileSize(file.size));
                    filePreview.show();
                } else {
                    errorSpan.hide();
                    filePreview.hide();
                }
            });

            // Handle remove file button
            $('#removeFile').on('click', function() {
                $('#MedicalCertificate').val('');
                $('#filePreview').hide();
                $('#medicalCertificateError').hide();
            });

            // Handle day type selection
            $('input[name="DayType"]').on('change', function() {
                console.log('Day type changed to:', $(this).val());
                calculateDuration();
            });

            // ✅ FIXED: Handle leave type selection with proper Emergency Leave display
            $('#LeaveTypeID').on('change', function() {
                const leaveTypeId = $(this).val();
                const availableDaysDiv = $('#availableDays');
                const medicalCertificateSection = $('#medicalCertificateSection');
                const dayTypeSection = $('#dayTypeSection');

                console.log('Leave type selected:', leaveTypeId);

                // Show day type selection for all leave types
                if (leaveTypeId) {
                    dayTypeSection.show();
                } else {
                    dayTypeSection.hide();
                }

                // Show/hide medical certificate section based on leave type name
                const isMedicalLeave = leaveTypeId && leaveBalances[leaveTypeId] &&
                                      leaveBalances[leaveTypeId].typeName.toLowerCase().includes('medical');

                console.log('Is medical leave:', isMedicalLeave);

                if (isMedicalLeave) {
                    medicalCertificateSection.show();
                    $('#MedicalCertificate').prop('required', true);
                } else {
                    medicalCertificateSection.hide();
                    $('#MedicalCertificate').prop('required', false);
                    // Clear any selected file when switching away from medical leave
                    $('#MedicalCertificate').val('');
                    $('#filePreview').hide();
                    $('#medicalCertificateError').hide();
                }

                // Update date restrictions
                updateDateRestrictions(leaveTypeId);

                if (!leaveTypeId) {
                    availableDaysDiv.text('Select a leave type to see available days');
                    availableDaysDiv.removeClass('text-danger text-success text-warning').addClass('text-muted');
                    return;
                }

                // ✅ FIXED: Validate leave type exists
                if (!isValidLeaveType(leaveTypeId)) {
                    availableDaysDiv.text('Invalid leave type selected');
                    availableDaysDiv.removeClass('text-muted text-success text-warning').addClass('text-danger');
                    console.error('Invalid leave type:', leaveTypeId, 'Available types:', Object.keys(leaveBalances));
                    return;
                }

                const balance = leaveBalances[leaveTypeId];
                const remainingDays = balance.remaining;
                const maxDays = balance.maxDays;

                // ✅ FIXED: Special display for Emergency Leave
                if (balance.typeName.toLowerCase().includes('emergency')) {
                    availableDaysDiv.html(`<strong>${remainingDays}</strong> of ${maxDays} days remaining<br><small class="text-info">(Uses Annual Leave Balance)</small>`);
                } else {
                    availableDaysDiv.html(`<strong>${remainingDays}</strong> of ${maxDays} days remaining`);
                }

                // Color coding based on remaining balance
                availableDaysDiv.removeClass('text-muted text-danger text-success text-warning');
                if (remainingDays === 0) {
                    availableDaysDiv.addClass('text-danger');
                } else if (remainingDays < 3) {
                    availableDaysDiv.addClass('text-warning');
                } else {
                    availableDaysDiv.addClass('text-success');
                }

                calculateDuration();
            });

            // Handle date changes
            $('#StartDate, #EndDate').on('change', function() {
                calculateDuration();
            });

            // ✅ FIXED: Calculate duration function with half day support
            function calculateDuration() {
                const startDate = $('#StartDate').val();
                const endDate = $('#EndDate').val();
                const leaveTypeId = $('#LeaveTypeID').val();
                const dayType = $('input[name="DayType"]:checked').val();

                console.log('Calculating duration:', { startDate, endDate, leaveTypeId, dayType });

                if (startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);

                    if (end >= start) {
                        const timeDiff = end.getTime() - start.getTime();
                        let daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;

                        // Apply half day calculation
                        if (dayType === 'half') {
                            if (daysDiff === 1) {
                                daysDiff = 0.5;
                            } else {
                                daysDiff = daysDiff - 0.5;
                            }
                        }

                        console.log('Calculated days:', daysDiff);

                        $('#calculatedDuration').text(daysDiff);
                        $('#durationInfo').show();

                        // ✅ FIXED: Check if duration exceeds available balance
                        if (isValidLeaveType(leaveTypeId)) {
                            const availableBalance = leaveBalances[leaveTypeId].remaining;

                            if (daysDiff > availableBalance) {
                                $('#balanceWarning').show();
                                $('#durationInfo').removeClass('alert-info').addClass('alert-warning');
                            } else {
                                $('#balanceWarning').hide();
                                $('#durationInfo').removeClass('alert-warning').addClass('alert-info');
                            }
                        }
                    } else {
                        $('#durationInfo').hide();
                    }
                } else {
                    $('#durationInfo').hide();
                }
            }

            // Set minimum date to today initially
            const today = new Date().toISOString().split('T')[0];
            $('#StartDate').attr('min', today);

            // Update end date minimum when start date changes
            $('#StartDate').on('change', function() {
                const startDate = $(this).val();

                if (startDate) {
                    $('#EndDate').attr('min', startDate);
                    if ($('#EndDate').val() && $('#EndDate').val() < startDate) {
                        $('#EndDate').val(startDate);
                    }
                }
                calculateDuration();
            });

            // ✅ FIXED: Form validation before submission
            $('form').on('submit', function(e) {
                console.log('Form submission started');

                // Get form values
                const leaveTypeId = $('#LeaveTypeID').val();
                const startDate = $('#StartDate').val();
                const endDate = $('#EndDate').val();
                const reason = $('#Reason').val().trim();
                const dayType = $('input[name="DayType"]:checked').val();

                console.log('Form data before validation:', { leaveTypeId, startDate, endDate, reason, dayType });

                // Prevent double submission
                const submitBtn = $(this).find('button[type="submit"]');
                if (submitBtn.prop('disabled')) {
                    console.log('Form already submitting, preventing double submission');
                    e.preventDefault();
                    return false;
                }

                // Basic validation
                let validationFailed = false;

                if (!leaveTypeId) {
                    console.log('Validation failed: No leave type selected');
                    alert('Please select a leave type.');
                    $('#LeaveTypeID').focus();
                    validationFailed = true;
                }

                if (!startDate) {
                    console.log('Validation failed: No start date');
                    alert('Please select a start date.');
                    $('#StartDate').focus();
                    validationFailed = true;
                }

                if (!endDate) {
                    console.log('Validation failed: No end date');
                    alert('Please select an end date.');
                    $('#EndDate').focus();
                    validationFailed = true;
                }

                if (!reason) {
                    console.log('Validation failed: No reason provided');
                    alert('Please provide a reason for your leave.');
                    $('#Reason').focus();
                    validationFailed = true;
                }

                if (validationFailed) {
                    e.preventDefault();
                    return false;
                }

                // ✅ FIXED: Validate leave type exists in our balances
                if (!isValidLeaveType(leaveTypeId)) {
                    console.error('Invalid leave type during submission:', leaveTypeId);
                    console.error('Available leave types:', Object.keys(leaveBalances));
                    alert('Please select a valid leave type from the dropdown.');
                    $('#LeaveTypeID').focus();
                    e.preventDefault();
                    return false;
                }

                // Medical leave specific validation
                const isMedicalLeave = leaveBalances[leaveTypeId].typeName.toLowerCase().includes('medical');
                if (isMedicalLeave) {
                    const medicalCertFile = $('#MedicalCertificate')[0].files[0];
                    if (!medicalCertFile) {
                        console.log('Validation failed: Medical certificate required');
                        alert('Please upload a medical certificate for medical leave applications.');
                        $('#MedicalCertificate').focus();
                        e.preventDefault();
                        return false;
                    }

                    const validation = validateFile(medicalCertFile);
                    if (!validation.isValid) {
                        console.log('Validation failed: Invalid medical certificate');
                        alert('Medical certificate validation failed: ' + validation.message);
                        $('#MedicalCertificate').focus();
                        e.preventDefault();
                        return false;
                    }
                }

                // Date validation
                const start = new Date(startDate);
                const end = new Date(endDate);

                if (end < start) {
                    console.log('Validation failed: End date before start date');
                    alert('End date must be after or equal to start date.');
                    $('#EndDate').focus();
                    e.preventDefault();
                    return false;
                }

                // ✅ FIXED: Balance validation with half day support
                const timeDiff = end.getTime() - start.getTime();
                let daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;

                if (dayType === 'half') {
                    if (daysDiff === 1) {
                        daysDiff = 0.5;
                    } else {
                        daysDiff = daysDiff - 0.5;
                    }
                }

                const availableBalance = leaveBalances[leaveTypeId].remaining;

                if (daysDiff > availableBalance) {
                    const leaveName = leaveBalances[leaveTypeId].typeName;
                    const balanceSource = leaveName.toLowerCase().includes('emergency') ? ' (from Annual Leave balance)' : '';
                    const confirmMsg = `You are requesting ${daysDiff} day(s) but only have ${availableBalance} day(s) remaining for ${leaveName}${balanceSource}.\n\nDo you want to proceed anyway?`;

                    if (!confirm(confirmMsg)) {
                        console.log('User cancelled submission due to insufficient balance');
                        e.preventDefault();
                        return false;
                    }
                }

                console.log('Form validation passed, proceeding with submission...');

                // Show loading state
                submitBtn
                    .prop('disabled', true)
                    .html('<i class="fas fa-spinner fa-spin me-2"></i>Submitting...');

                // Let the form submit naturally
                return true;
            });

            // Auto-resize textarea
            $('#Reason').on('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Initialize the form - trigger change event on page load if leave type is pre-selected
            if ($('#LeaveTypeID').val()) {
                console.log('Pre-selected leave type found, triggering change event');
                $('#LeaveTypeID').trigger('change');
            }

            // Debug: Log form state on page load
            console.log('Available leave types in dropdown:', $('#LeaveTypeID option').map(function() {
                return {value: this.value, text: this.text};
            }).get());

            // Debug: Log current form field values
            console.log('Initial form values:', {
                leaveType: $('#LeaveTypeID').val(),
                startDate: $('#StartDate').val(),
                endDate: $('#EndDate').val(),
                reason: $('#Reason').val()
            });
        });
    </script>
}